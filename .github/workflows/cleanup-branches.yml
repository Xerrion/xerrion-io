name: Cleanup Branches

on:
  schedule:
    - cron: '0 3 * * 1' # Every Monday at 03:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup:
    name: Delete Merged & Stale Branches
    runs-on: ubuntu-latest
    steps:
      - name: Delete merged branches
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          gh api "repos/${GH_REPO}/branches" --paginate \
            --jq '.[] | select(.name | test("^(master|main|develop|release/.*)$") | not) | .name' |
          while read -r branch; do
            ahead=$(gh api "repos/${GH_REPO}/compare/master...${branch}" \
              --jq '.ahead_by' 2>/dev/null || echo "1")
            if [ "$ahead" = "0" ]; then
              echo "Deleting merged branch: ${branch}"
              gh api --method DELETE "repos/${GH_REPO}/git/refs/heads/${branch}"
            fi
          done

      - name: Delete stale branches
        uses: beatlabs/delete-old-branches-action@4eeeb8740ff8b3cb310296ddd6b43c3387734588 # v0.0.11
        with:
          repo_token: ${{ github.token }}
          date: '90 days ago'
          dry_run: false
          delete_tags: false
          extra_protected_branch_regex: '^(master|main|develop|release/.*)$'
